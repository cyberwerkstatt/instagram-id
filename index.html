<!doctype html>
<html lang="de">
<meta charset="utf-8">
<title>Instagram-ID Finder</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:800px}
  label{display:block;margin:8px 0 4px}
  input{width:100%;padding:10px}
  button{padding:10px 14px;margin-top:10px;cursor:pointer}
  .kv{display:grid;grid-template-columns:180px 1fr;gap:6px 12px;margin-top:12px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word}
  .card{margin-top:14px;padding:12px;border:1px solid #ddd;border-radius:8px;background:#fafafa}

  /* Neu für Medien-Grid und Metadaten */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px}
  .tile{border:1px solid #ddd;border-radius:8px;padding:8px;background:#fff}
  .tile img,.tile video{width:100%;height:auto;border-radius:6px;display:block}
  .muted{color:#666;font-size:13px}
</style>

<h1>Instagram-ID Finder</h1>
<label>API Key <input id="key" type="password" placeholder="api-key"></label>
<label>Instagram Benutzername oder URL
  <input id="q" placeholder="z. B. username oder https://instagram.com/username">
</label>
<button id="go">Abfragen</button>

<div id="out" class="card" style="display:none">
  <strong>Ergebnis</strong>
  <div class="kv">
    <div>Extrahierte ID</div><div id="id" class="mono">–</div>
    <div>Benutzername</div><div id="uname" class="mono">–</div>
    <div>Vollname</div><div id="fname" class="mono">–</div>
    <div>Follower</div><div id="followers" class="mono">–</div>
    <div>Following</div><div id="following" class="mono">–</div>
    <div>Beiträge</div><div id="posts" class="mono">–</div>
    <div>Profilbild</div><div id="avatar" class="mono">–</div>
  </div>

  <button id="loadPosts">Neueste Posts laden (Bilder/Videos)</button>
  <div class="muted">Hinweis: Bei privaten Accounts oder eingeschränkten Endpunkten kann die Liste leer bleiben.</div>

  <div id="media" class="grid" style="display:none"></div>

  <details style="margin-top:10px">
    <summary>Rohantwort (Profil)</summary>
    <pre id="raw" class="mono"></pre>
  </details>

  <details style="margin-top:10px">
    <summary>Rohantwort (Posts)</summary>
    <pre id="rawPosts" class="mono"></pre>
  </details>
</div>

<script>
    const $ = id => document.getElementById(id);
    const host = "instagram-scraper-api2.p.rapidapi.com";

    function toNumber(v) {
        const n = Number(v);
        return Number.isFinite(n) ? n.toLocaleString() : (v ?? "–");
    }

    function escapeHtml(s) {
        return String(s ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function link(href, text, filename) {
        const a = document.createElement("a");
        a.href = href;
        a.textContent = text;
        if (filename) a.download = filename; // Hinweis: bei Cross-Origin kann der Browser 'download' ignorieren
        a.target = "_blank";
        a.rel = "noopener";
        return a;
    }

    function extractProfile(json) {
        const u = json?.data ?? json ?? {};
        const pp = u.hd_profile_pic_url_info?.url || u.profile_pic_url_hd || u.profile_pic_url || null;
        const ppVers = u.hd_profile_pic_versions || [];
        return {
            id: u.id ?? u.instagram_pk ?? u.fbid_v2 ?? null,
            username: u.username ?? u.full_name ?? null,
            full_name: u.full_name ?? u.name ?? null,
            followers: u.follower_count ?? u.edge_followed_by?.count ?? null,
            following: u.following_count ?? u.edge_follow?.count ?? null,
            posts: u.media_count ?? u.edge_owner_to_timeline_media?.count ?? null,
            avatarUrl: pp,
            avatarSizes: ppVers
        };
    }

    async function run() {
        let handle = $("q").value.trim();
        const key = $("key").value.trim();
        if (!key) return alert("Bitte RapidAPI Key eingeben.");
        if (!handle) return alert("Bitte Benutzername oder URL eingeben.");

        // URL → Handle
        try {
            const u = new URL(handle);
            const parts = u.pathname.split("/").filter(Boolean);
            if (parts.length) handle = parts[0];
        } catch (e) { }

        $("out").style.display = "block";
        $("id").textContent = "Suche…";
        $("uname").textContent = handle;
        $("fname").textContent = "–";
        $("followers").textContent = "–";
        $("following").textContent = "–";
        $("posts").textContent = "–";
        $("avatar").textContent = "–";
        $("raw").textContent = "";
        $("rawPosts").textContent = "";
        $("media").style.display = "none";
        $("media").innerHTML = "";

        const url = `https://${host}/v1/info?username_or_id_or_url=${encodeURIComponent(handle)}`;

        try {
            const res = await fetch(url, {
                headers: {
                    "x-rapidapi-key": key,
                    "x-rapidapi-host": host
                }
            });
            const text = await res.text();
            $("raw").textContent = text;
            let json;
            try { json = JSON.parse(text); } catch { json = {}; }

            if (!res.ok) {
                $("id").textContent = `Fehler: HTTP ${res.status}`;
                return;
            }

            const u = extractProfile(json);
            $("id").textContent = u.id ?? "nicht gefunden";
            $("uname").textContent = u.username ?? handle ?? "–";
            $("fname").textContent = u.full_name ?? "–";
            $("followers").textContent = toNumber(u.followers);
            $("following").textContent = toNumber(u.following);
            $("posts").textContent = toNumber(u.posts);

            // Profilbild-Download-Links
            const avatarDiv = $("avatar");
            avatarDiv.innerHTML = "";
            if (u.avatarUrl) {
                const main = link(
                    u.avatarUrl,
                    "Profilbild (groß) öffnen/speichern",
                    `avatar_${u.username || handle}.jpg`
                );
                avatarDiv.appendChild(main);
                if (u.avatarSizes && Array.isArray(u.avatarSizes)) {
                    u.avatarSizes.forEach((v, i) => {
                        avatarDiv.appendChild(document.createTextNode(" · "));
                        avatarDiv.appendChild(
                            link(
                                v.url,
                                `${v.width || ""}x${v.height || ""}`.replace(/x$/, "") || `Variante ${i + 1}`,
                                `avatar_${u.username || handle}_${v.width || i}.jpg`
                            )
                        );
                    });
                }
            } else {
                avatarDiv.textContent = "kein Profilbild gefunden";
            }

            // Posts-Button aktivieren mit Kontext
            $("loadPosts").onclick = () => loadPosts(key, u.id || u.username || handle);

        } catch (e) {
            $("id").textContent = "Fehler bei Anfrage";
            $("raw").textContent = String(e);
        }
    }

    // Versuche mehrere mögliche Post-Endpunkte und parse gängige Felder.
    async function loadPosts(key, idOrHandle) {
        const endpoints = [
            (q) => `https://${host}/v1/posts?username_or_id_or_url=${encodeURIComponent(q)}`,
            (q) => `https://${host}/v1/user_posts?username_or_id_or_url=${encodeURIComponent(q)}`,
            (q) => `https://${host}/v1/medias?username_or_id_or_url=${encodeURIComponent(q)}`,
            (q) => `https://${host}/v1/user_medias?username_or_id_or_url=${encodeURIComponent(q)}`
        ];

        let data = null, raw = null, lastStatus = null;
        for (const build of endpoints) {
            const url = build(idOrHandle);
            try {
                const res = await fetch(url, {
                    headers: {
                        "x-rapidapi-key": key,
                        "x-rapidapi-host": host
                    }
                });
                lastStatus = res.status;
                const text = await res.text();
                raw = text;
                const json = JSON.parse(text);
                const items = findMediaItems(json);
                if (Array.isArray(items) && items.length) {
                    data = { json, items, url };
                    break;
                }
                if (Array.isArray(items)) {
                    data = { json, items, url };
                    break;
                }
            } catch (e) {
                // nächster Endpoint
            }
        }

        $("rawPosts").textContent = raw
            ? raw
            : `Keine verwertbare Antwort (letzter Status: ${lastStatus ?? "unbekannt"})`;

        const container = $("media");
        container.innerHTML = "";
        if (!data) {
            container.style.display = "block";
            container.innerHTML = `<div class="muted">Keine Posts gefunden oder Endpunkt nicht verfügbar.</div>`;
            return;
        }

        const tiles = [];
        for (const m of data.items.slice(0, 30)) { // begrenze auf 30
            const urls = extractMediaUrls(m);
            const isVideo = !!urls.video;
            const div = document.createElement("div");
            div.className = "tile";

            if (isVideo) {
                const video = document.createElement("video");
                video.src = urls.video;
                video.controls = true;
                div.appendChild(video);
                const dl = link(
                    urls.video,
                    "Video speichern",
                    `ig_${m.id || m.code || "post"}.mp4`
                );
                dl.style.display = "inline-block";
                div.appendChild(dl);
            } else if (urls.images && urls.images.length) {
                const img = document.createElement("img");
                img.src = urls.images[0];
                div.appendChild(img);
                div.appendChild(document.createElement("br"));
                div.appendChild(
                    link(
                        urls.images[0],
                        "Bild speichern",
                        `ig_${m.id || m.code || "post"}.jpg`
                    )
                );
                if (urls.images.length > 1) {
                    const more = document.createElement("div");
                    more.className = "muted";
                    more.textContent = `+ ${urls.images.length - 1} weitere Bild(er) in Carousel`;
                    div.appendChild(document.createElement("br"));
                    div.appendChild(more);
                    urls.images.slice(1).forEach((u, i) => {
                        div.appendChild(document.createElement("br"));
                        div.appendChild(
                            link(
                                u,
                                `Weitere Bild ${i + 2}`,
                                `ig_${m.id || m.code || "post"}_${i + 2}.jpg`
                            )
                        );
                    });
                }
            } else {
                const p = document.createElement("div");
                p.className = "muted";
                p.textContent = "Kein direktes Medien-URL extrahierbar.";
                div.appendChild(p);
            }

            // Metadaten aus der JSON (Reels / Posts)
            const captionText = m.caption?.text || "";
            const hashtagsArray = m.caption?.hashtags || [];
            const hashtags = Array.isArray(hashtagsArray)
                ? hashtagsArray
                    .map(h => (typeof h === "string" ? h : h.name || ""))
                    .filter(Boolean)
                    .join(" ")
                : "";

            const takenIso = m.taken_at_date
                || (m.taken_at ? new Date(m.taken_at * 1000).toISOString() : null);
            const takenLocal = takenIso ? new Date(takenIso).toLocaleString() : "–";

            const likeCount = m.like_count;
            const playCount = m.play_count ?? m.ig_play_count;
            const commentCount = m.comment_count;

            const locName = m.location?.name || null;
            const locCoords = (m.lat && m.lng) ? `(${m.lat}, ${m.lng})` : null;

            const meta = document.createElement("div");
            meta.className = "muted";
            meta.style.marginTop = "6px";

            meta.innerHTML =
                `<strong>${escapeHtml(takenLocal)}</strong><br>` +
                (captionText
                    ? `${escapeHtml(
                        captionText.length > 200
                            ? captionText.slice(0, 200) + "…"
                            : captionText
                    )}<br>`
                    : "") +
                `Likes: ${toNumber(likeCount)} · Views: ${toNumber(playCount)} · Kommentare: ${toNumber(commentCount)}<br>` +
                (locName
                    ? `Ort: ${escapeHtml(locName)}${locCoords ? " " + escapeHtml(locCoords) : ""}<br>`
                    : "") +
                (hashtags ? `Hashtags: ${escapeHtml(hashtags)}` : "");

            div.appendChild(document.createElement("hr"));
            div.appendChild(meta);

            tiles.push(div);
        }
        tiles.forEach(t => container.appendChild(t));
        container.style.display = "grid";
    }

    // Hilfsfunktionen zur Medien-Extraktion aus diversen API-Schemata
    function findMediaItems(json) {
        if (Array.isArray(json?.data?.items)) return json.data.items;
        if (Array.isArray(json?.items)) return json.items;
        if (Array.isArray(json?.data)) return json.data;
        if (Array.isArray(json?.media)) return json.media;
        const edges = json?.data?.user?.edge_owner_to_timeline_media?.edges;
        if (Array.isArray(edges)) return edges.map(e => e.node);
        return [];
    }

    function extractMediaUrls(item) {
        const urls = { images: [], video: null };

        // Video – verschiedene Varianten
        if (Array.isArray(item?.video_versions) && item.video_versions.length) {
            urls.video = item.video_versions
                .sort((a, b) => (b.width || 0) - (a.width || 0))[0].url;
        }
        if (!urls.video && item?.video_url) {
            urls.video = item.video_url;
        }

        // Einzelbild (klassische IG-API)
        if (Array.isArray(item?.image_versions2?.candidates)) {
            const img = item.image_versions2.candidates
                .sort((a, b) => (b.width || 0) - (a.width || 0))[0]?.url;
            if (img) urls.images.push(img);
        }

        // NEU: Reels/Posts-Struktur aus image_versions.items[].url
        if (Array.isArray(item?.image_versions?.items)) {
            const candidates = item.image_versions.items;
            const img = candidates
                .sort((a, b) => (b.width || 0) - (a.width || 0))[0]?.url;
            if (img) urls.images.push(img);
        }

        // Fallback: Thumbnail
        if (!urls.images.length && item?.thumbnail_url) {
            urls.images.push(item.thumbnail_url);
        }

        // Carousel (klassische IG-API)
        if (Array.isArray(item?.carousel_media)) {
            for (const c of item.carousel_media) {
                if (Array.isArray(c?.image_versions2?.candidates)) {
                    const img = c.image_versions2.candidates
                        .sort((a, b) => (b.width || 0) - (a.width || 0))[0]?.url;
                    if (img) urls.images.push(img);
                }
                if (!urls.video && Array.isArray(c?.video_versions) && c.video_versions.length) {
                    urls.video = c.video_versions
                        .sort((a, b) => (b.width || 0) - (a.width || 0))[0]?.url;
                }
            }
        }

        // GraphQL-ähnlich
        if (!urls.images.length && item?.display_url) {
            urls.images.push(item.display_url);
        }
        const children = item?.edge_sidecar_to_children?.edges;
        if (Array.isArray(children)) {
            for (const e of children) {
                const n = e?.node;
                if (n?.is_video && !urls.video) urls.video = n?.video_url || null;
                if (n?.display_url) urls.images.push(n.display_url);
            }
        }
        return urls;
    }

    $("go").addEventListener("click", run);
    $("q").addEventListener("keydown", e => { if (e.key === "Enter") run(); });
</script>

</html>

